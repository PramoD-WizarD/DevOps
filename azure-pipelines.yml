trigger:
  branches:
    include:
    - main

variables:
- name: PACKAGE_NAME
  value: DevOps
- name: MSR_HOME
  value: /mnt/app/wm1015/IntegrationServer

stages:
- stage: Deploy_MSR
  jobs:
  - job: Deploy
    pool:
      name: SelfHosted-Linux   # ðŸ‘ˆ your self-hosted agent pool
    steps:

    - checkout: self

    - task: Bash@3
      displayName: "Zip webMethods package"
      inputs:
        targetType: inline
        script: |
          zip -r $(PACKAGE_NAME).zip $(PACKAGE_NAME)

    - task: CopyFilesOverSSH@0
      displayName: "Copy package to MSR VM"
      inputs:
        sshEndpoint: MSR-SSH
        sourceFolder: $(System.DefaultWorkingDirectory)
        contents: "$(PACKAGE_NAME).zip"
        targetFolder: /tmp

    - task: SSH@0
      displayName: "Deploy package to MSR"
      inputs:
        sshEndpoint: MSR-SSH
        runOptions: inline
        inline: |
          cd $(MSR_HOME)/packages
          unzip -o /tmp/$(PACKAGE_NAME).zip

    - task: SSH@0
      displayName: "Restart MSR"
      inputs:
        sshEndpoint: MSR-SSH
        runOptions: inline
        inline: |
          cd $(MSR_HOME)/bin
          ./shutdown.sh
          sleep 10
          ./startup.sh
